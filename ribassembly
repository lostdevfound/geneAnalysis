#!/bin/bash
set -e

#### This script takes the contigs generated by soap and aligns them to the ribsomal dna reference.
#### Thereafter it substitutes the portions of the reference by contigs producing a complete genome.

currentDir=`pwd`
refFasta=${currentDir}/genome-ref/ribosomal-reference.fasta

workdata=( "casc" )
# workdata=( "casc" "cent" "colb" "fugg" "gold" "mtho" "nugg" "sora" "wila" )

for dirName in ${workdata[@]}
do
    seqPref=`echo $dirName | tr [:lower:] [:upper:]`
    cd workdata/${dirName}/contigs/soap


    echo "######### start aligning $dirName #########"
    bwa mem -R '@RG\tID:HWI-ST765\tSM:sample1\tLB:None\tPL:Illumina' $refFasta ${dirName}.scafSeq > ribo-${dirName}-scaf.sam

    echo "########################### sam processing start: ${dirName} ###############################"
    samtools view -F 4 -bh -q 10 ribo-${dirName}-scaf.sam | samtools sort -n - | samtools fixmate -m - ribo-${dirName}-scaf.fix.bam &&
    samtools sort ribo-${dirName}-scaf.fix.bam | samtools markdup -r - ribo-${dirName}-scaf.sorted.bam &&
    samtools index ribo-${dirName}-scaf.sorted.bam

    rm  ribo-${dirName}-scaf.fix.bam

    # echo "########################### variance call start: ${dirName} ###############################"
    #
    # bcftools  mpileup -f ${refFasta} ribo-${dirName}-scaf.sorted.bam | bcftools call -mv > ribo-${dirName}-scaf.vcf
    #
    # echo "########################### consensus sequence start: ${dirName} ###############################"
    # ## compress
    # bgzip -c ribo-${dirName}-scaf.vcf > ribo-${dirName}-scaf.vcf.gz &&
    # ## index
    # bcftools index ribo-${dirName}-scaf.vcf.gz &&
    # ## create consensus
    # bcftools consensus -s sample1 -f ${refFasta} ribo-${dirName}-scaf.vcf.gz > ribo-${dirName}-consensus.fa
    #
    # ## generate a report about the contigs
    # python3.5 $quast -R $refFasta -o soapQuastReport ${dirName}.contig
    #
    # if [ $? != 0 ]; then
    #     echo "variance call went wrong: ${dirName}"
    #     exit 1
    # fi

    cd $currentDir
done
